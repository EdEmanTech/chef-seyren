<% require 'bson' %>
<% @hosts.each do |node| %>
<% target = "#{node.chef_environment}.#{node[:hostname]}.load.load.shortterm" %>
{ "_id" : "<%= BSON::ObjectId.new %>", "name" : "<%= node[:hostname] %> shortterm", "description" : "Generated by Chef.", "target" : "<%= target %>", "enabled" : true, "warn" : "<%= node[:cpu][:total]*0.8 %>", "error" : "<%= node[:cpu][:total]*1.0 %>", "live" : false, "state": "OK", "subscriptions": [] }
<% node[:filesystem].each do |key, value|
  if !value['mount'].nil? && !value['kb_size'].nil?
    mount = nil
    if value['mount'] == '/'
      if value['fs_type'] != 'rootfs'
        mount = 'root'
      end
    else
      mount = value['mount'].gsub(/^\//, '').gsub(/\//, '-')
    end
    if !mount.nil?
      serie1 = "#{node.chef_environment}.#{node[:hostname]}.df.#{mount}.df_complex.free"
      serie2 = "sumSeries(#{node.chef_environment}.#{node[:hostname]}.df.#{mount}.df_complex.*)" %>
{ "_id" : "<%= BSON::ObjectId.new %>", "name" : "<%= node[:hostname] %> df <%= mount %>", "description" : "Generated by Chef.", "target" : "asPercent(<%= serie1 %>, <%= serie2 %>)", "enabled" : true, "warn" : "80", "error" : "95", "live" : false, "state": "OK", "subscriptions": [] }
    <% end
  end
end %>
<% end %>